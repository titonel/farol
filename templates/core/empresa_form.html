{% extends 'base.html' %}

{% block title %}{{ acao }} Empresa - Farol{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-building"></i> {{ acao }} Empresa</h2>
        <p class="text-muted">Preencha os dados da empresa abaixo</p>
    </div>
</div>

<div class="row">
    <div class="col-lg-9">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Dados da Empresa</h5>
            </div>
            <div class="card-body">
                <form method="post" id="empresaForm">
                    {% csrf_token %}
                    
                    {# Seção: Identificação #}
                    <div class="form-section mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-building"></i> Identificação
                        </h6>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.razao_social.id_for_label }}" class="form-label">
                                        <i class="bi bi-card-text"></i> {{ form.razao_social.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.razao_social }}
                                    {% if form.razao_social.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.razao_social.errors }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.nome_fantasia.id_for_label }}" class="form-label">
                                        <i class="bi bi-tag"></i> {{ form.nome_fantasia.label }}
                                    </label>
                                    {{ form.nome_fantasia }}
                                    {% if form.nome_fantasia.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.nome_fantasia.errors }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.cnpj.id_for_label }}" class="form-label">
                                        <i class="bi bi-file-earmark-binary"></i> {{ form.cnpj.label }}
                                        <span class="text-danger">*</span>
                                    </label>
                                    {{ form.cnpj }}
                                    {% if form.cnpj.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.cnpj.errors }}</small>
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Formato: 00.000.000/0000-00</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.telefone.id_for_label }}" class="form-label">
                                        <i class="bi bi-telephone"></i> {{ form.telefone.label }}
                                    </label>
                                    {{ form.telefone }}
                                    {% if form.telefone.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.telefone.errors }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.email.id_for_label }}" class="form-label">
                                        <i class="bi bi-envelope"></i> {{ form.email.label }}
                                    </label>
                                    {{ form.email }}
                                    {% if form.email.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.email.errors }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {# Seção: Endereço #}
                    <div class="form-section mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-geo-alt"></i> Endereço
                        </h6>
                        
                        {# CEP com botão de busca #}
                        <div class="row">
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.cep.id_for_label }}" class="form-label">
                                        <i class="bi bi-mailbox"></i> {{ form.cep.label }}
                                    </label>
                                    <div class="input-group">
                                        {{ form.cep }}
                                        <button class="btn btn-outline-primary" type="button" id="buscarCepBtn">
                                            <i class="bi bi-search"></i> Buscar
                                        </button>
                                    </div>
                                    {% if form.cep.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.cep.errors }}</small>
                                        </div>
                                    {% endif %}
                                    <small class="form-text text-muted">Digite o CEP e clique em Buscar</small>
                                    <div id="cep-loading" class="text-primary mt-1" style="display: none;">
                                        <small><i class="bi bi-hourglass-split"></i> Buscando endereço...</small>
                                    </div>
                                    <div id="cep-error" class="text-danger mt-1" style="display: none;">
                                        <small><i class="bi bi-exclamation-triangle"></i> <span id="cep-error-msg"></span></small>
                                    </div>
                                    <div id="cep-success" class="text-success mt-1" style="display: none;">
                                        <small><i class="bi bi-check-circle"></i> Endereço encontrado!</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        {# Logradouro e Número #}
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="{{ form.logradouro.id_for_label }}" class="form-label">
                                        <i class="bi bi-signpost"></i> {{ form.logradouro.label }}
                                    </label>
                                    {{ form.logradouro }}
                                    {% if form.logradouro.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.logradouro.errors }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.numero.id_for_label }}" class="form-label">
                                        <i class="bi bi-hash"></i> {{ form.numero.label }}
                                    </label>
                                    {{ form.numero }}
                                    {% if form.numero.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.numero.errors }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {# Complemento e Bairro #}
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.complemento.id_for_label }}" class="form-label">
                                        <i class="bi bi-building"></i> {{ form.complemento.label }}
                                    </label>
                                    {{ form.complemento }}
                                    {% if form.complemento.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.complemento.errors }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="{{ form.bairro.id_for_label }}" class="form-label">
                                        <i class="bi bi-map"></i> {{ form.bairro.label }}
                                    </label>
                                    {{ form.bairro }}
                                    {% if form.bairro.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.bairro.errors }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        
                        {# Cidade e Estado #}
                        <div class="row">
                            <div class="col-md-8">
                                <div class="mb-3">
                                    <label for="{{ form.cidade.id_for_label }}" class="form-label">
                                        <i class="bi bi-pin-map"></i> {{ form.cidade.label }}
                                    </label>
                                    {{ form.cidade }}
                                    {% if form.cidade.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.cidade.errors }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label for="{{ form.estado.id_for_label }}" class="form-label">
                                        <i class="bi bi-flag"></i> {{ form.estado.label }}
                                    </label>
                                    {{ form.estado }}
                                    {% if form.estado.errors %}
                                        <div class="text-danger mt-1">
                                            <small><i class="bi bi-exclamation-circle"></i> {{ form.estado.errors }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    {# Seção: Status #}
                    <div class="form-section mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-toggle-on"></i> Status
                        </h6>
                        <div class="mb-3">
                            <div class="form-check form-switch">
                                {{ form.ativa }}
                                <label class="form-check-label" for="{{ form.ativa.id_for_label }}">
                                    <strong>{{ form.ativa.label }}</strong>
                                    <br>
                                    <small class="text-muted">Empresas inativas não aparecerão nas listagens principais</small>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4">
                    
                    {# Botões de Ação #}
                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        <a href="{% url 'empresa_lista' %}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Voltar
                        </a>
                        <div>
                            <button type="reset" class="btn btn-outline-secondary me-2">
                                <i class="bi bi-x-circle"></i> Limpar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-check-circle"></i> Salvar Empresa
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    {# Sidebar com informações #}
    <div class="col-lg-3">
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informações</h6>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <small class="text-muted d-block mb-2">
                        <i class="bi bi-asterisk text-danger"></i> <strong>Campos Obrigatórios</strong>
                    </small>
                    <ul class="list-unstyled small">
                        <li><i class="bi bi-check2 text-success"></i> Razão Social</li>
                        <li><i class="bi bi-check2 text-success"></i> CNPJ</li>
                    </ul>
                </div>
                
                <hr>
                
                <div class="mb-3">
                    <small class="text-muted d-block mb-2">
                        <i class="bi bi-lightbulb"></i> <strong>Dicas</strong>
                    </small>
                    <ul class="list-unstyled small text-muted">
                        <li class="mb-2"><i class="bi bi-dot"></i> O CNPJ deve ser único no sistema</li>
                        <li class="mb-2"><i class="bi bi-dot"></i> Digite o CEP e clique em "Buscar" para preencher automaticamente</li>
                        <li class="mb-2"><i class="bi bi-dot"></i> Você pode corrigir os dados após a busca</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0"><i class="bi bi-search"></i> Busca de CEP</h6>
            </div>
            <div class="card-body">
                <small class="text-muted">
                    <i class="bi bi-globe"></i> Sistema integrado com a API ViaCEP para busca automática de endereços.
                </small>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.form-section {
    padding: 1.5rem;
    background-color: #f8f9fa;
    border-radius: 8px;
    border-left: 4px solid var(--secondary-color);
}

.form-section h6 {
    font-weight: 600;
    margin-bottom: 1rem;
}

.form-check-input:checked {
    background-color: var(--success-color);
    border-color: var(--success-color);
}

.card-header h6 {
    color: var(--primary-color);
    font-weight: 600;
}

.form-label i {
    color: var(--secondary-color);
    margin-right: 0.25rem;
}

#buscarCepBtn:hover {
    transform: scale(1.05);
    transition: all 0.2s ease;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Busca de CEP via API ViaCEP
document.addEventListener('DOMContentLoaded', function() {
    const cepField = document.getElementById('cep_field');
    const buscarBtn = document.getElementById('buscarCepBtn');
    const loading = document.getElementById('cep-loading');
    const error = document.getElementById('cep-error');
    const success = document.getElementById('cep-success');
    const errorMsg = document.getElementById('cep-error-msg');
    
    // Campos de endereço
    const logradouroField = document.getElementById('logradouro_field');
    const bairroField = document.getElementById('bairro_field');
    const cidadeField = document.getElementById('cidade_field');
    const estadoField = document.getElementById('estado_field');
    const numeroField = document.getElementById('numero_field');
    
    function limparMensagens() {
        loading.style.display = 'none';
        error.style.display = 'none';
        success.style.display = 'none';
    }
    
    function buscarCEP() {
        const cep = cepField.value.replace(/\D/g, '');
        
        if (cep.length !== 8) {
            limparMensagens();
            error.style.display = 'block';
            errorMsg.textContent = 'CEP inválido. Digite 8 dígitos.';
            return;
        }
        
        limparMensagens();
        loading.style.display = 'block';
        buscarBtn.disabled = true;
        
        fetch(`https://viacep.com.br/ws/${cep}/json/`)
            .then(response => response.json())
            .then(data => {
                limparMensagens();
                buscarBtn.disabled = false;
                
                if (data.erro) {
                    error.style.display = 'block';
                    errorMsg.textContent = 'CEP não encontrado.';
                    return;
                }
                
                // Preenche os campos
                logradouroField.value = data.logradouro || '';
                bairroField.value = data.bairro || '';
                cidadeField.value = data.localidade || '';
                estadoField.value = data.uf || '';
                
                success.style.display = 'block';
                
                // Foca no campo número para o usuário continuar
                numeroField.focus();
                
                // Esconde mensagem de sucesso após 3 segundos
                setTimeout(() => {
                    success.style.display = 'none';
                }, 3000);
            })
            .catch(err => {
                limparMensagens();
                buscarBtn.disabled = false;
                error.style.display = 'block';
                errorMsg.textContent = 'Erro ao buscar CEP. Tente novamente.';
                console.error('Erro:', err);
            });
    }
    
    // Event listeners
    if (buscarBtn) {
        buscarBtn.addEventListener('click', buscarCEP);
    }
    
    if (cepField) {
        // Busca ao pressionar Enter
        cepField.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarCEP();
            }
        });
        
        // Formata o CEP enquanto digita
        cepField.addEventListener('input', function(e) {
            let value = e.target.value.replace(/\D/g, '');
            if (value.length > 5) {
                value = value.substring(0, 5) + '-' + value.substring(5, 8);
            }
            e.target.value = value;
        });
    }
    
    // Força estado em maiúsculas
    if (estadoField) {
        estadoField.addEventListener('input', function(e) {
            e.target.value = e.target.value.toUpperCase();
        });
    }
    
    // Validação do formulário
    const form = document.getElementById('empresaForm');
    if (form) {
        form.addEventListener('submit', function(e) {
            const razaoSocial = document.querySelector('input[name="razao_social"]');
            const cnpj = document.querySelector('input[name="cnpj"]');
            
            if (!razaoSocial.value.trim()) {
                e.preventDefault();
                alert('⚠️ Por favor, preencha a Razão Social.');
                razaoSocial.focus();
                return false;
            }
            
            if (!cnpj.value.trim()) {
                e.preventDefault();
                alert('⚠️ Por favor, preencha o CNPJ.');
                cnpj.focus();
                return false;
            }
        });
    }
});
</script>
{% endblock %}
